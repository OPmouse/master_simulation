% proposed method ---
\chapter[Active Period Detection of Primary Signal for Spectrum Database]{Proposed Method}
\label{chapter:Propose}
\section{System model}
\label{system}

We assume that a sensor node tunes to a frequency band and obtains samples ${\bf y}=\left\{y[1],y[2],...,y[N]\right\}$ from a primary transmitter. $N$ is the sample number during the sensing period. Since a multiple ON/OFF environment is considered, the sensing samples ${\boldmath y}$ is shown in Fig. 2 as follows

\begin{eqnarray}
{\large
y[i] = 
\begin{cases}
\;n[i],    i=1,...\tau_1-1 \\ \nonumber
\; \\ \nonumber
\;x[i]+n[i], i=\tau_1,...,\tau_2-1 \\
\; \\ \nonumber
\;n[i],    i=\tau_2,..,N,
\end{cases}
}
\end{eqnarray}

where $\tau_1$ and $\tau_2$ is the rise up point at which primary user starts to transmit and rise down point at which primary user stop transmitting respectively. If $\tau_1=1$ and $\tau_2=N$, the primary user is always transmitting during the sensing period. On the other hand, if $\tau_1=1$ and $\tau_2=1$, the primary user is not at present during the sensing period. In this paper, we consider only the primary user starts and stops transmission during the sensing period.
If the primary user is not transmitting, $y[i] = n[i]$, in which $n[i]$ is Addative White Gaussian Noise with mean 0 and variance $\sigma^2$. If the primary user starts transmitting, then $y[i] = x[i] + n[i]$, in which $x[i] = gs[i]$. $g$ is the channel gain and the $s[i]$ is the signal of the primary user. Therefore, we assume $x[i]$ is white and Gaussian with mean 0 and variance $P$. $P$ depends on the channel gain and the transmitter power of the primary user. In the wireless environment, the signal of the primary experiences pathloss and shadowing and  multipath fading, so the value of $P$ is not possible to be known accurately by the sensor. Thus, as a solution to received power detection problem, a transition point detection algorithm is considered. 

\section{Transition Point Detection Method under Multiple ON/OFF Environment }    

In this section, transition point detection algorithm for the status of primary user is introduced in detail. As the Fig. \ref{system_model} is shown, the sample of the ON and OFF status follows a Gaussian distribution $\mathcal{N}(0,\sigma^2+P)$ and $\mathcal{N}(0,\sigma^2)$ respectively. The probability density function(PDF) follows the eq. (\ref{normal}) is given by

\begin{eqnarray}
{\large
\begin{cases}
\;f_0(t) = \frac{1}{\sqrt{2\pi\sigma^2}} \rm{exp}\left\{-\frac{t^2}{2\sigma^2}\right\} \\
\; \\ \nonumber
\;f_1(t) = \frac{1}{\sqrt{2\pi(\sigma^2+P)}} \rm{exp}\left\{-\frac{t^2}{2(\sigma^2+P)}\right\}.
\end{cases}
}
\label{normal}
\end{eqnarray}

\begin{center}
  \begin{figure}[t]
    \centering
    \includegraphics[width=120mm]{systemodel.eps}
    \label{system_model}
    \caption{\normalsize{System model.}}
  \end{figure}
\end{center} 

\subsection{CUSUM algorithm}
The cumulative sum (CUSUM) algorithm, which was first proposed by Page in \cite{ref:CUSUM}, is used to detection the transition point when $P$ and $\sigma^2$ is assumed to be known.
The PDF $f_0(t)$ and $f_1(t)$ are fully specified. Thus, the log probability density ratio $l(y[i])$ is also fully defined by the eq. (\ref{like1}) and (\ref{like2}),


\begin{center}
  \begin{figure}[t]
    \centering
    \includegraphics[width=120mm]{cusum_image.eps}
    \label{cusum_image}
    \caption{The image of cusum algorithm.}
  \end{figure}
\end{center} 


\begin{eqnarray}
l_{0}(y[i]) &=& {\rm ln}\left\{\frac{f_0(y[i])}{f_1(y[i])}\right\} \label{like1} \\ 
&=& -\frac{2(P+\sigma^2)\sigma^2}{Py^2[i]} + \frac{1}{2}{\rm ln}\left\{\frac{P+\sigma^2}{\sigma^2}\right\}, \nonumber
\end{eqnarray}

\begin{eqnarray}
l_{1}(y[i]) &=& {\rm ln}\left\{\frac{f_1(y[i])}{f_0(y[i])}\right\} \label{like2} \\ 
&=& \frac{Py^2[i]}{2(P+\sigma^2)\sigma^2} + \frac{1}{2}{\rm ln}\left\{\frac{\sigma^2}{P+\sigma^2}\right\}. \nonumber
\end{eqnarray}

When the primary user is on the OFF and ON status, the average log probability density ratio can be calculated respectively using the eq. (\ref{D_f0}) and (\ref{D_f1}),
\begin{eqnarray}
E_{f_0}\left\{l_0(y[i])\right\} &=& -\int f_0(y){\rm ln}\left\{\frac{f_0(y)}{f_1(y)}\right\}dy \nonumber \\ 
&=&-D(f_0||f_1)\leq 0, \label{D_f0} 
\end{eqnarray}
\begin{eqnarray}
E_{f_1}\left\{l_1(y[i])\right\} &=& \int f_1(y){\rm ln}\left\{\frac{f_1(y)}{f_0(y)}\right\}dy \nonumber \\
&=& D(f_1||f_0)\geq 0 \label{D_f1},
\end{eqnarray}
where $D(f_0||f_1)$ is the Kullback-Leibler divergence of $f_0$ from $f_1$ and $D(f_1||f_0)$ vice versa, which is shown in eq. (\ref{KL})
\begin{eqnarray}
D(f_0||f_1)=\frac{P}{2(P+\sigma^2)}+\frac{1}{2}{\rm ln}\left\{\frac{\sigma^2}{\sigma^2+P}\right\}.
\label{KL}
\end{eqnarray}
Hence, when the primary user is at present, which means the sample before primary user changes its status from OFF to ON, the probability density ratio $l(y)$ has a negative trend. After a change point from ON to OFF, $l(y)$ has a positive trend.
Using the characterics discussed above, an algorithm for detecting a status transition (ON$\rightarrow$OFF or OFF$\rightarrow$ON) of the primary user can be defined as comparing,  
\begin{eqnarray}
g_t =  \max_{k \leq t}\left\{\sum_{i=1}^tl(y[i]-\sum_{i=1}^kl(y[i]))\right\}=\max_{k \leq t}\sum_{i=k+1}^tl(y[i]),
\label{Cusum}
\end{eqnarray}
with a threshold $h$. If $g_t$ is larger than $h$, the existence of the primary user is declared. Since $l(y)$ has a positive trend during the ON status of the primary.

\begin{figure}[t]
\centering
\includegraphics[width=120mm]{OFF2ON.eps}
\caption{ Statistic $g_t$ using the probability density ratio $l_0(y)$  when the rise up point is 512th sample and the rise down point is 1532th sample.}
\label{OFF2ON}
\end{figure}

Also, the eq. (\ref{Cusum}) can be written as
\begin{eqnarray}
g_{t+1} &=& \max_{k \leq t+1}\left\{\sum_{i=k+1}^{t+1}l(y[i])\right\} \nonumber \\ 
&=& \max\left\{\max_{k \leq t+1}\left\{\sum_{i=k+1}^{t+1}l(y[i])\right\},0\right\} \nonumber \\
&=& \max\left\{\max_{k \leq t+1}\left\{\sum_{i=k+1}^{t+1}l(y[i])\right\}+l(y[i]),0\right\} \nonumber \\
&=& \left\{g_t+l(y[t+1])\right\}^{+}.
\label{rec}
\end{eqnarray}
$\left\{.\right\}^{+}$means that the value must be postive. Hence, $g_t$ can be computed recursively by setting $g_0=0$. To sum up, the CUSUM algorithm works as the following process:
\begin{enumerate}
  \item[i]. compute $l(y)$ for each sample using eq. (\ref{like1}) or (\ref{like2}).
  \item[ii]. compute the statistic $g_t$ using eq. (\ref{rec}).
  \item[iii]. compare the statistic $g_t$ with a threshold $h$.
  \item[iv]. If $g_t \geq h$, the existence of the primary user is declared.
\end{enumerate}

\subsection{GLR algorithm}
In realistic wireless channels, the exact value of $P$ is difficult to be known exactly. It is more reasonable to assume that $P$ belongs to a range, that is $P\in[P_{{\rm min}}, P_{\rm {max}}]$. In this case, a generalized likelihood ratio(GLR) algorithm\cite{ref:GLR} for transition point detection is applied. Since the value of $P$ is unknown, the statistic $g_t$ is defined as the following eq. (\ref{Glr}),
\begin{eqnarray}
g_t &=& \max_{k \leq t}\left\{ \sum_{i=k+1}^tl(y[i])\right\}={\rm ln}\left\{\prod_{i=k+1}^k\frac{f_{1,P}(y[i])}{f_0(y[i])}\right\} \nonumber \\ 
   &=& \max_{k \leq t}\left\{\sum_{i=k+1}^t\left\{ \frac{Py^2[i]}{2(P+\sigma^2)\sigma^2}+\frac{1}{2} {\rm ln}(\frac{\sigma^2}{P+\sigma^2}) \right\}\right\},
\label{Glr}
\end{eqnarray}
\begin{figure}[t]
\centering
\includegraphics[width=120mm]{ON2OFF.eps}
\caption{Statistic $g_t$ using the probability density ratio $l_1(y)$ when the raise up point is 512th sample and the raise down point is 1532th sample.}
\label{ON2OFF}
\end{figure}
where $f_{1,P}(t)$ is the probability density function of the received signal when the varinace of the signal part is $P$. Therefore a function $f(P)$ defined as eq. (\ref{fp}) is used to calculate the statistic $g_t$,
\begin{eqnarray}
f(P) &=& \sum_{i=k+1}^t\left\{ \frac{Py^2[i]}{2(P+\sigma^2)\sigma^2}+\frac{1}{2} {\rm ln}(\frac{\sigma^2}{P+\sigma^2})\right\} \nonumber\\ 
&=&\frac{P}{2(P+\sigma^2)\sigma^2}\hat{y}+(t-k)\frac{1}{2}{\rm ln}\left\{ \frac{\sigma^2}{P+\sigma^2} \right\},
\label{fp}
\end{eqnarray}
where $\hat{y}=\sum_{i=k+1}^t y[i]^2$. To find a the power $P^{*}$ that maximizes the function $f(P)$ over $P \in [P_{{\rm min}}, P_{{\rm max}}]$, it can be calculated as below,

\begin{align}
{\large
P^{*}=
\begin{cases}
\;P_{{\rm max}}, & (t-k)\leq\frac{\hat{y}}{P_{{\rm max}}+\sigma^2}, \\
\; \\ 
\;\frac{\hat{y}}{t-k}-\sigma^2, & \frac{\hat{y}}{P_{{\rm max}}+\sigma^2}\leq(t-k)\leq\frac{\hat{y}}{P_{{\rm min}}+\sigma^2}, \label{maxP} \\ 
\; \\
\; P_{{\rm min}}, & (t-k) \geq \frac{\hat{y}}{P_{{\rm min}}+\sigma^2}.
\end{cases}
}
\end{align}

As a derivation, the the function $f(P)$ is differentiated with respect to $P$ first and the eq. \ref{Differentiate} is shown as follows,
\begin{eqnarray}
f^{'}(P)=\frac{\hat{y}}{2}\frac{1}{(P+\sigma^2)^2}-\frac{t-k}{2(P+\sigma^2)}.
\label{Differentiate}
\end{eqnarray}

And then, $f^{'}(P)=0$ is set to determine a extreme value and it is $P^{*}=\frac{\hat{y}}{t-k}-\sigma^2$, which $P^{*}$ is assumed to be the extreme point of the function  $f^{'}(P)$. Because the maximum of ${f(P)}$ is the final goal we want, the appropiate $P$ should be determined during the the range $[P_{min},P_{max}]$. As the function $f(P)$ is a concave function as shown in Fig. \ref{concave}, the extreme value is the value when  $P^{*}=\frac{\hat{y}}{t-k}-\sigma^2$ and 3 possible cases can be considered as follows,
\begin{eqnarray}
{\large
\begin{cases}
\;1. \ \ \ {\rm max}\left\{f(P)\right\}=f(P_{{\rm max}}), \ \ \ P_{{\rm max}}<\frac{\hat{y}}{t-k}-\sigma^2, \\
\;\\
\;2. \ \ \ {\rm max}\left\{f(P)\right\}=f(P^{*}), \ \ \ P_{{\rm min}}<\frac{\hat{y}}{t-k}-\sigma^2<P_{{\rm min}},\\
\;\\
\;3. \ \ \ {\rm max}\left\{f(P)\right\}=f(P_{{\rm min}}), \ \ \ P_{{\rm min}}>\frac{\hat{y}}{t-k}-\sigma^2.
\end{cases}
}
\end{eqnarray}
Finally, the maximum value of function $f(P)$ can be determined by eq.\ref{maxP} as shown before.

As same as the CUSUM algorithm, in the GLR algorithm the statistic value $g_t$ is calculated in eq.(\ref{Glr}) with choosing the a power $P^{*}$ from the eq.(\ref{maxP}), and is compared with the threshold $h$. Once $g_t>h$, the existance of the primary user is declared.

\begin{center}
  \begin{figure}[t]
    \centering
    \includegraphics[width=100mm]{fp.eps}
    \label{concave}
    \caption{The image of funcition $f(P)$.}
  \end{figure}
\end{center} 

\subsection{Threshold configuration for CUSUM and GLR algorithm}
To set a threshold for the transition point detection, we first assume $t_0$ denotes the time when the statistic $g_t$ exceeds the threshold $h$, and define $\bar{T_0}=E[t_0]$ is the mean time to a false alarm. Following \cite{ref:threshold_cusum} and \cite{ref:threshold_GLR}, some simple bounds on $\bar{T_0}$ can be derived.

For CUSUM algorithm, the relationship between the mean false alarm and threshold is as follows.
\begin{eqnarray}
\bar{T_0} \geq e^h.
\end{eqnarray}
For GLR algorithm, the threshold is set to be $h=-{\rm ln}\left\{\frac{a}{b}\right\}$ , where 
\begin{eqnarray}
b=3{\rm ln}\left\{a^{-1}(1+\frac{1}{D(f_1,P_{{\rm min}}||f_0)})^2\right\},
\end{eqnarray}
and $a$ follows the following inequality.
\begin{eqnarray}
\bar{T_0} \geq \frac{1}{a}.
\end{eqnarray}

\section{Peak detection for transition point}
\label{PeakD}
Except CUSUM and GLR algorithm, we propose a peak detection for transition point detection. As shown in Fig. \ref{peak_OFF2ON} and \ref{peak_ON2OFF}, the cumulative sum of the log likelihood raito $l_1(y)$ and $l_0(y)$ will reach a peak value when a transition point between ON and OFF or OFF and ON. Therefore, instead of a threshold-based transition point detection method, a peak detection is adopted to detect transition point more accurately. Same as CUSUM and GLR algorithm, a detailed peak detetion process for transition point detecting is shown as follows.  

\begin{enumerate}
  \item[i]. compute $l(y)$ for each sample using eq. (\ref{like1}) or (\ref{like2}).
  \item[ii]. compute the statistic $g_t$ using eq. (\ref{rec}).
  \item[iii]. detect the maximum of $g_t$ as the peak value. 
  \item[iv]. If the peak value of $g_t$ is detected, the sample ID associated with peak value is declared as the transition point, which is from ON to OFF or OFF to ON.
\end{enumerate}

\begin{center}
  \begin{figure}[!htp]
    \centering
    \includegraphics[width=100mm]{peak_OFF2ON.eps}
    \label{peak_OFF2ON}
    \caption{Peak detection image for rise up point.}
  \end{figure}
\end{center} 

\begin{center}
  \begin{figure}[!htp]
    \centering
    \includegraphics[width=100mm]{peak_ON2OFF.eps}
    \label{peak_ON2OFF}
    \caption{Peak detection image for rise down point.}
  \end{figure}
\end{center} 

\section{Avtive Period Detection}
In this section, the proposed active period detection using the CUSUM and GLR algorithm and peak detection discussed above is introduced. 

First, the statistics $g_t$ calculation results related to the sample ID using the probability density ratio $l_0(y)$ and $l_1(y)$ are shown in Figs.\ref{OFF2ON} and \ref{ON2OFF}, respectively. The rise up point is set to be the 512th sample and the rise down point is set to be 1532th sample.
In Figure \ref{OFF2ON}, when a status of the primary user from OFF to ON changes, the statistic $g_t$ shows a increase trend, and when the status changes from ON to OFF, a decrease trend is shown. The reason is that if the probability density ratio $l_0(y)$ is used to calculate the statistics $g_t$, the ON samples show a positive trend and OFF samples a negative trend. Then in this case, the statistics $g_t$ exceeds the threshold $h$, the rise up point is declared to be detected.

Samely, in Figure \ref{ON2OFF}, when a status of the primary user from OFF to ON changes, the statistic $g_t$ shows a increase trend, and when the status changes from ON to OFF, a decrease trend is shown. The reason is that if the probability density ratio $l_1(y)$ is used to calculate the statistics $g_t$, the ON samples show a negative trend and OFF samples a positive trend. Thus, the statistics $g_t$ exceeds the threshold $h$, the rise down point is declared to be detected.

At last, as introduced in sec.\ref{PeakD}, the active period detection with peak detection utilizes the peak value of $g_t$ to dectect the transition point to be Different from CUSUM and GLR algorithm.

Based on the detected rise up and rise down point, an active period of the primary user is extracted to calculate the received power. Since the only ON samples is detected to be used for calculating the received power, it may mitigate the sensing error compared with not considering ON sample extraction.
